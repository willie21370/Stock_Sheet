<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future Stock Price Valuation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        /* Style for the valuation cells to make them stand out */
        .val-cell { font-weight: 600; }
        /* Common loading animation for both buttons */
        .loading-animation { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Future Stock Price Valuation</h1>
            <p class="text-xl text-indigo-600">P/E and P/S Multiples Analysis</p>
        </header>

        <!-- Main Inputs -->
        <div id="mainInputs" class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 card">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Core Financial Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <label class="block">
                    <span class="text-gray-700 font-medium">Current Stock Price ($)</span>
                    <input type="number" id="currentPrice" value="15.00" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                </label>
                <label class="block">
                    <span class="text-gray-700 font-medium">Public Shares (M)</span>
                    <input type="number" id="publicShares" value="3" step="0.1" min="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                </label>
                <label class="block">
                    <span class="text-gray-700 font-medium">Current Cash (M)</span>
                    <input type="number" id="currentCash" value="162.00" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50">
                </label>
            </div>
        </div>

        <!-- Dynamic Inputs (EPS and Revenue Projections) -->
        <div id="projectionInputs" class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 card">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8l2-2m0 0l2 2m-2-2v8m-4-8h4m-4 4h4m-4 4h4"></path></svg>
                Annual Projections
            </h2>
            <div id="dataInputsContainer" class="space-y-4">
                <!-- Inputs generated by JS -->
            </div>
        </div>

        <!-- P/E Valuation Table -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 card overflow-x-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-6 3h6m0 0l-3 3m3-3l-3-3m-6 3h6m0 0l-3 3m3-3l-3-3m-6 3h6m0 0l-3 3m3-3l-3-3m-6 3h6m0 0l-3 3m3-3l-3-3"></path></svg>
                P/E Multiples Valuation (EPS-Based)
            </h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr id="peHeader">
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPS ($)</th>
                        <!-- P/E Multiples populated by JS -->
                    </tr>
                </thead>
                <tbody id="peTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- P/S Valuation Table -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 card overflow-x-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2h-1a1 1 0 00-1 1v2.883m1.7-5.877L16 11"></path></svg>
                P/S Multiples Valuation (Revenue-Based)
            </h2>
            <p class="text-sm text-gray-600 mb-4">Calculation: (Revenue (M) × P/S Multiple) / Public Shares (M)</p>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr id="psHeader">
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue (M)</th>
                        <!-- P/S Multiples populated by JS -->
                    </tr>
                </thead>
                <tbody id="psTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- LLM Valuation Analysis Section -->
        <div class="bg-indigo-50 p-6 md:p-8 rounded-xl shadow-lg mb-8 card">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 border-b border-indigo-200 pb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M3.636 5.636l.707.707m0 10.728l-.707.707m6.364 1.636l-.707.707M12 21v-1m-6.364-1.636l.707-.707M18.364 18.364l-.707-.707M12 12h.01"></path></svg>
                Valuation Insights & Market Grounding
            </h2>
            <p class="text-indigo-700 mb-4">Generate AI-powered summaries of your projections and market context.</p>
            
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <!-- Button 1: Valuation Analysis (Existing) -->
                <button id="analyzeButton" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <div id="loadingIndicator" class="hidden loading-animation"></div>
                    Generate Valuation Analysis ✨
                </button>

                <!-- New Button 2: Market Insights -->
                <button id="insightsButton" class="flex-1 px-6 py-3 bg-purple-600 text-white font-semibold rounded-full shadow-md hover:bg-purple-700 transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <div id="loadingInsights" class="hidden loading-animation" style="border-top-color: #f7f9fb;"></div>
                    Market Comps & Multiples Suggestion ✨
                </button>
            </div>

            <!-- Result 1: Valuation Analysis (Existing) -->
            <div id="analysisResult" class="mt-6 p-4 bg-white rounded-lg shadow-inner text-gray-800 hidden">
                <h3 class="text-lg font-bold mb-2 text-indigo-700">Analyst Summary:</h3>
                <p id="analysisText"></p>
            </div>
            
            <!-- New Result 2: Market Insights -->
            <div id="insightsResult" class="mt-6 p-4 bg-white rounded-lg shadow-inner text-gray-800 hidden">
                <h3 class="text-lg font-bold mb-2 text-purple-700">Grounded Market Insights:</h3>
                <p id="insightsText"></p>
                <div id="insightsSources" class="mt-2 text-xs text-gray-500"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Gemini API Configuration ---
        const API_KEY = ""; // Automatically provided by the environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- Configuration (Same as before) ---
        const PE_MULTIPLES = [20, 25, 30, 40, 50, 60, 70, 80, 90, 100];
        const PS_MULTIPLES = [3, 5, 8];

        // Default data from the user's uploaded spreadsheet
        let projections = [
            { year: 2025, eps: 0.1, rev: 150 },
            { year: 2026, eps: 0.3, rev: 470 },
            { year: 2027, eps: 0.85, rev: 1000 },
            { year: 2028, eps: 1.5, rev: 1300 },
        ];

        // --- DOM Elements ---
        const currentPriceInput = document.getElementById('currentPrice');
        const publicSharesInput = document.getElementById('publicShares');
        const dataInputsContainer = document.getElementById('dataInputsContainer');
        const peTableBody = document.getElementById('peTableBody');
        const psTableBody = document.getElementById('psTableBody');
        
        // Existing LLM Elements
        const analyzeButton = document.getElementById('analyzeButton');
        const analysisResultDiv = document.getElementById('analysisResult');
        const analysisTextP = document.getElementById('analysisText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // New LLM Elements
        const insightsButton = document.getElementById('insightsButton');
        const insightsResultDiv = document.getElementById('insightsResult');
        const insightsTextP = document.getElementById('insightsText');
        const insightsSourcesDiv = document.getElementById('insightsSources');
        const loadingInsights = document.getElementById('loadingInsights');


        // --- Utility Functions ---

        /**
         * Formats a number as USD currency.
         * @param {number} value
         */
        const formatCurrency = (value) => {
            if (isNaN(value)) return 'N/A';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        };

        /**
         * Parses input value as a float, defaulting to 0 if invalid.
         * @param {string} id - The ID of the input element.
         * @returns {number} The parsed float value.
         */
        const getInputValue = (id) => {
            const el = document.getElementById(id);
            if (!el) return 0;
            const value = parseFloat(el.value);
            return isNaN(value) ? 0 : value;
        };
        
        /**
         * Generic function to fetch with exponential backoff for LLM calls.
         */
        const fetchWithRetry = async (url, options, retries = 0) => {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries < MAX_RETRIES) {
                    console.warn(`Rate limit hit, retrying in ${Math.pow(2, retries)}s...`);
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    throw new Error(`API call failed: ${response.statusText} - ${errorBody.error?.message || 'Unknown API Error'}`);
                }
                return response.json();
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw new Error(`API call failed after ${MAX_RETRIES} attempts: ${error.message}`);
            }
        };

        // --- Core Calculation Logic ---

        /**
         * Calculates future price based on EPS and P/E multiples.
         */
        const calculatePEValuation = () => {
            peTableBody.innerHTML = ''; // Clear existing rows
            const lastYear = projections[projections.length - 1];
            let minPEPrice = Infinity;
            let maxPEPrice = -Infinity;

            projections.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-indigo-50';
                
                // Year and EPS columns
                let rowContent = `<td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.year}</td>`;
                rowContent += `<td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${formatCurrency(p.eps).replace('$', '')}</td>`; // Display EPS without $

                // Valuation columns
                PE_MULTIPLES.forEach(multiple => {
                    const price = p.eps * multiple;
                    const priceFormatted = formatCurrency(price);
                    rowContent += `<td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-900 val-cell">${priceFormatted}</td>`;

                    // Capture min/max for the final year only
                    if (p.year === lastYear.year) {
                        minPEPrice = Math.min(minPEPrice, price);
                        maxPEPrice = Math.max(maxPEPrice, price);
                    }
                });
                
                row.innerHTML = rowContent;
                peTableBody.appendChild(row);
            });
            return { min: minPEPrice, max: maxPEPrice, year: lastYear.year, eps: lastYear.eps };
        };

        /**
         * Calculates future price based on Revenue and P/S multiples.
         */
        const calculatePSValuation = () => {
            psTableBody.innerHTML = ''; // Clear existing rows
            const sharesInMillions = getInputValue('publicShares');
            const lastYear = projections[projections.length - 1];
            let minPSPrice = Infinity;
            let maxPSPrice = -Infinity;

            projections.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-indigo-50';
                
                // Year and Revenue columns
                let rowContent = `<td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.year}</td>`;
                rowContent += `<td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${p.rev.toLocaleString()} M</td>`;

                // Valuation columns
                PS_MULTIPLES.forEach(multiple => {
                    let price = 0;
                    if (sharesInMillions > 0) {
                        // Formula: (Revenue * P/S Multiple) / Public Shares (M)
                        price = (p.rev * multiple) / sharesInMillions;
                    }
                    const priceFormatted = formatCurrency(price);
                    rowContent += `<td class="px-3 py-3 whitespace-nowrap text-sm text-center text-gray-900 val-cell">${priceFormatted}</td>`;

                     // Capture min/max for the final year only
                    if (p.year === lastYear.year) {
                        minPSPrice = Math.min(minPSPrice, price);
                        maxPSPrice = Math.max(maxPSPrice, price);
                    }
                });

                row.innerHTML = rowContent;
                psTableBody.appendChild(row);
            });
            return { min: minPSPrice, max: maxPSPrice, year: lastYear.year, rev: lastYear.rev };
        };
        
        /**
         * Uses the Gemini API to analyze the valuation scenario (existing feature).
         */
        const analyzeValuation = async () => {
            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            analysisResultDiv.classList.add('hidden');
            analysisTextP.textContent = '';
            
            const currentPrice = getInputValue('currentPrice');
            const publicShares = getInputValue('publicShares');
            const currentCash = getInputValue('currentCash');

            // Recalculate to ensure we have the latest min/max price data
            const peData = calculatePEValuation();
            const psData = calculatePSValuation();
            
            const finalYear = peData.year;
            const finalEPS = peData.eps;
            const finalRev = psData.rev;
            
            const minProjectedPrice = Math.min(peData.min, psData.min);
            const maxProjectedPrice = Math.max(peData.max, psData.max);
            
            const minPE = PE_MULTIPLES[0]; 
            const maxPE = PE_MULTIPLES[PE_MULTIPLES.length - 1]; 
            const minPS = PS_MULTIPLES[0]; 
            const maxPS = PS_MULTIPLES[PS_MULTIPLES.length - 1]; 
            
            const systemPrompt = "You are a concise, professional equity research analyst. Your task is to provide a single-paragraph summary of the stock's potential risk/reward based *only* on the provided financial metrics and projected valuations. Highlight the percentage difference between the current price and the conservative/aggressive targets.";

            const userQuery = `Current Stock Price: ${formatCurrency(currentPrice)}. Public Shares: ${publicShares}M. Current Cash: ${currentCash}M.

            Projections for ${finalYear}:
            - EPS: ${finalEPS}
            - Revenue: ${finalRev}M

            Projected Valuation Range (based on P/E ${minPE}x to ${maxPE}x and P/S ${minPS}x to ${maxPS}x):
            - Conservative Target (Minimum): ${formatCurrency(minProjectedPrice)}
            - Aggressive Target (Maximum): ${formatCurrency(maxProjectedPrice)}

            Provide a single-paragraph analysis focusing on the upside and downside risk implied by these targets.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = response.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    analysisTextP.textContent = text;
                    analysisResultDiv.classList.remove('hidden');
                } else {
                    analysisTextP.textContent = "Could not generate analysis. The LLM response was empty.";
                    analysisResultDiv.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                analysisTextP.textContent = `Error during analysis: ${error.message}. Please check your projections and try again.`;
                analysisResultDiv.classList.remove('hidden');
            } finally {
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        };

        /**
         * Uses the Gemini API with Google Search Grounding for market insights (NEW FEATURE).
         */
        const generateMarketInsights = async () => {
            insightsButton.disabled = true;
            loadingInsights.classList.remove('hidden');
            insightsResultDiv.classList.add('hidden');
            insightsTextP.textContent = '';
            insightsSourcesDiv.innerHTML = '';
            
            const currentPrice = getInputValue('currentPrice');
            const finalYear = projections[projections.length - 1].year;
            
            // Use 2025 (first year) and 2028 (last year) for CAGR
            const startEPS = projections[0].eps;
            const finalEPS = projections[projections.length - 1].eps;
            const startRev = projections[0].rev;
            const finalRev = projections[projections.length - 1].rev;

            // Calculate current P/E and P/S multiples (based on the first projection year, 2025)
            const currentPE = startEPS > 0 ? currentPrice / startEPS : 'N/A';
            const publicShares = getInputValue('publicShares');
            const currentPS = (startRev > 0 && publicShares > 0) ? (currentPrice * publicShares) / startRev : 'N/A';
            
            // Calculate CAGR (from 2025 to 2028, assuming 3 years)
            const years = finalYear - projections[0].year; 
            let epsGrowth = "N/A";
            let revGrowth = "N/A";

            if (startEPS > 0 && finalEPS > 0) {
                epsGrowth = (Math.pow(finalEPS / startEPS, 1 / years) - 1) * 100;
            }
            if (startRev > 0 && finalRev > 0) {
                revGrowth = (Math.pow(finalRev / startRev, 1 / years) - 1) * 100;
            }

            const systemPrompt = "You are a specialized financial research assistant. Use Google Search to find two comparable public companies (comps) that share a similar growth profile or operate in a relevant sector. Then, suggest a grounded, realistic P/E and P/S multiple range for the stock based on the comps or sector data. Summarize your findings in two concise, separate paragraphs: one for comps and one for suggested multiples.";
            
            const userQuery = `Analyze a stock with the following profile:
            - Estimated ${years}-year EPS CAGR (${projections[0].year}-${finalYear}): ${epsGrowth !== 'N/A' ? epsGrowth.toFixed(1) + '%' : 'Insufficient data'}
            - Estimated ${years}-year Revenue CAGR (${projections[0].year}-${finalYear}): ${revGrowth !== 'N/A' ? revGrowth.toFixed(1) + '%' : 'Insufficient data'}
            - Current Multiples (based on ${projections[0].year} projections): P/E=${typeof currentPE === 'number' ? currentPE.toFixed(1) + 'x' : currentPE}, P/S=${typeof currentPS === 'number' ? currentPS.toFixed(1) + 'x' : currentPS}.
            
            Use Google Search to find comparable public companies and recommend a realistic P/E and P/S range for this growth rate.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable Google Search grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = response.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;
                let sources = [];
                
                // Extract sources if grounding was used
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                if (text) {
                    insightsTextP.textContent = text;
                    insightsResultDiv.classList.remove('hidden');
                    
                    if (sources.length > 0) {
                        const sourceHtml = sources.map((s, i) => 
                            `<a href="${s.uri}" target="_blank" class="underline text-indigo-500 hover:text-indigo-600">${s.title}</a>`
                        ).join(' | ');
                        insightsSourcesDiv.innerHTML = `Sources: ${sourceHtml}`;
                    } else {
                        insightsSourcesDiv.innerHTML = 'Sources: No external sources found.';
                    }
                    
                } else {
                    insightsTextP.textContent = "Could not generate market insights. The LLM response was empty.";
                    insightsResultDiv.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini API Error (Market Insights):", error);
                insightsTextP.textContent = `Error during market insights generation: ${error.message}. Please check console for details.`;
                insightsResultDiv.classList.remove('hidden');
            } finally {
                insightsButton.disabled = false;
                loadingInsights.classList.add('hidden');
            }
        };

        // --- Initialization and UI setup ---

        /**
         * Main recalculation function.
         */
        const recalculateAll = () => {
            calculatePEValuation();
            calculatePSValuation();
            // Hide previous analysis if inputs change
            analysisResultDiv.classList.add('hidden');
            insightsResultDiv.classList.add('hidden');
        };


        /**
         * Renders the dynamic input fields for EPS and Revenue projections.
         */
        const renderDataInputs = () => {
            dataInputsContainer.innerHTML = '';

            projections.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-100';
                
                div.innerHTML = `
                    <div class="col-span-3"><span class="text-lg font-semibold text-indigo-700">Year ${p.year} Projections</span></div>
                    <label class="block">
                        <span class="text-gray-700 text-sm">Projected EPS ($)</span>
                        <input type="number" data-index="${index}" data-field="eps" value="${p.eps}" step="0.01" min="0" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 text-sm">Projected Revenue (M)</span>
                        <input type="number" data-index="${index}" data-field="rev" value="${p.rev}" step="1" min="0" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    </label>
                `;
                dataInputsContainer.appendChild(div);
            });

            // Add event listeners to dynamic inputs
            dataInputsContainer.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    projections[index][field] = parseFloat(e.target.value) || 0;
                    recalculateAll();
                });
            });
        };

        /**
         * Renders the header rows for both tables based on the constants.
         */
        const renderTableHeaders = () => {
            // P/E Header
            const peHeader = document.getElementById('peHeader');
            PE_MULTIPLES.forEach(m => {
                const th = document.createElement('th');
                th.className = 'px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-indigo-100/50 rounded-t-lg';
                th.textContent = `${m}x P/E`;
                peHeader.appendChild(th);
            });

            // P/S Header
            const psHeader = document.getElementById('psHeader');
            PS_MULTIPLES.forEach((m, index) => {
                const th = document.createElement('th');
                th.className = 'px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-indigo-100/50 rounded-t-lg';
                
                // Naming convention from the user's sheet: Base P/S (3) and Bull P/S (8)
                let label = `${m}x P/S`;
                if (m === 3) label = 'Base P/S (3x)';
                if (m === 8) label = 'Bull P/S (8x)';

                th.textContent = label;
                psHeader.appendChild(th);
            });
        };

        /**
         * Setup everything when the page loads.
         */
        const setupApp = () => {
            // Initial render of headers and input fields
            renderTableHeaders();
            renderDataInputs();
            
            // Add listeners to main inputs
            currentPriceInput.addEventListener('input', recalculateAll);
            publicSharesInput.addEventListener('input', recalculateAll);
            document.getElementById('currentCash').addEventListener('input', recalculateAll);
            
            // Add listeners for the LLM features
            analyzeButton.addEventListener('click', analyzeValuation);
            insightsButton.addEventListener('click', generateMarketInsights); // New listener

            // Run initial calculation
            recalculateAll();
        };

        // Run the setup function on window load
        window.onload = setupApp;
    </script>
</body>
</html>
